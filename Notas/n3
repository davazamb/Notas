public async Task<IActionResult> InsertarUsuarioAsync(Usuario usuario)
{
    const int maxIntentos = 3;
    int intentos = 0;

    while (intentos < maxIntentos)
    {
        await using var connection = new SqlConnection(connectionString);
        await connection.OpenAsync();

        await using var transaction = await connection.BeginTransactionAsync(IsolationLevel.Serializable);
        await using var command = connection.CreateCommand();
        command.Transaction = transaction;

        try
        {
            // 1. Obtener MAX(Id) de forma segura dentro de la transacciÃ³n
            command.CommandText = "SELECT ISNULL(MAX(Id), 0) + 1 FROM Usuarios";
            var result = await command.ExecuteScalarAsync();
            int nuevoId = Convert.ToInt32(result);

            usuario.Id = nuevoId;

            // 2. Preparar INSERT
            command.CommandText = @"
                INSERT INTO Usuarios (Id, Nombre, FechaNacimiento)
                VALUES (@Id, @Nombre, @FechaNacimiento)";
            command.Parameters.Clear();

            command.Parameters.Add(new SqlParameter("@Id", SqlDbType.Int) { Value = usuario.Id });
            command.Parameters.Add(new SqlParameter("@Nombre", SqlDbType.NVarChar, 100)
            {
                Value = usuario.Nombre ?? (object)DBNull.Value
            });

            command.Parameters.Add(new SqlParameter("@FechaNacimiento", SqlDbType.Date)
            {
                Value = usuario.FechaNacimiento > SqlDateTime.MinValue.Value
                    ? usuario.FechaNacimiento
                    : DBNull.Value
            });

            await command.ExecuteNonQueryAsync();
            await transaction.CommitAsync();

            return Ok($"âœ”ï¸ Usuario insertado con Id {usuario.Id}");
        }
        catch (SqlException ex) when (ex.Number == 2627 || ex.Number == 2601)
        {
            // ColisiÃ³n de Id â€” reintentar con nuevo MAX(Id)
            await transaction.RollbackAsync();
            intentos++;
            if (intentos >= maxIntentos)
                return Conflict("âš ï¸ No se pudo insertar: colisiÃ³n de clave primaria tras mÃºltiples intentos.");
        }
        catch (Exception ex)
        {
            await transaction.RollbackAsync();
            return StatusCode(500, $"ğŸ’¥ Error inesperado: {ex.Message}");
        }
    }

    return StatusCode(500, "ğŸš« No se pudo completar la inserciÃ³n tras varios intentos.");
}
